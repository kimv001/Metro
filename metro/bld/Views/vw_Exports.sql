
CREATE VIEW [bld].[vw_exports] AS /*
        View is generated by  : metro
        Generated at          : 2024-12-24 08:25:26
        Description           : View on stage table
        */  WITH cur AS

        (SELECT [exportsid] AS [exportsid],

               [bk] AS [bk],

               [code] AS [code],

               [export_name] AS [export_name],

               [bk_contactgroup] AS [bk_contactgroup],

               [bk_dataset] AS [bk_dataset],

               [src_datasetname] AS [src_datasetname],

               [src_schema] AS [src_schema],

               [src_dataset] AS [src_dataset],

               [src_shortname] AS [src_shortname],

               [src_group] AS [src_group],

               [src_layer] AS [src_layer],

               [src_datasettype] AS [src_datasettype],

               [bk_schedule] AS [bk_schedule],

               [bk_schema] AS [bk_schema],

               [container] AS [container],

               [folder] AS [folder],

               [filename] AS [filename],

               [datetime] AS [datetime],

               [bk_fileformat] AS [bk_fileformat],

               [where_filter] AS [where_filter],

               [order_by] AS [order_by],

               [split_by] AS [split_by],

               [ff_name] AS [ff_name],

               [ff_fileformat] AS [ff_fileformat],

               [ff_columndelimiter] AS [ff_columndelimiter],

               [ff_rowdelimiter] AS [ff_rowdelimiter],

               [ff_quotecharacter] AS [ff_quotecharacter],

               [ff_compressionlevel] AS [ff_compressionlevel],

               [ff_compressiontype] AS [ff_compressiontype],

               [ff_enablecdc] AS [ff_enablecdc],

               [ff_escapecharacter] AS [ff_escapecharacter],

               [ff_fileencoding] AS [ff_fileencoding],

               [ff_firstrow] AS [ff_firstrow],

               [ff_firstrowasheader] AS [ff_firstrowasheader],

               [repositorystatusname] AS [repositorystatusname],

               [repositorystatuscode] AS [repositorystatuscode],

               [mta_rectype],

               [mta_createdate],

               [mta_source],

               [mta_bk],

               [mta_bkh],

               [mta_rh],

               [mta_currentflag] = row_number() OVER (PARTITION BY [mta_bkh]
                                                 ORDER BY [mta_createdate] DESC)

          FROM [bld].[exports]
       )
SELECT [exportsid] AS [exportsid],

       [bk] AS [bk],

       [code] AS [code],

       [export_name] AS [export_name],

       [bk_contactgroup] AS [bk_contactgroup],

       [bk_dataset] AS [bk_dataset],

       [src_datasetname] AS [src_datasetname],

       [src_schema] AS [src_schema],

       [src_dataset] AS [src_dataset],

       [src_shortname] AS [src_shortname],

       [src_group] AS [src_group],

       [src_layer] AS [src_layer],

       [src_datasettype] AS [src_datasettype],

       [bk_schedule] AS [bk_schedule],

       [bk_schema] AS [bk_schema],

       [container] AS [container],

       [folder] AS [folder],

       [filename] AS [filename],

       [datetime] AS [datetime],

       [bk_fileformat] AS [bk_fileformat],

       [where_filter] AS [where_filter],

       [order_by] AS [order_by],

       [split_by] AS [split_by],

       [ff_name] AS [ff_name],

       [ff_fileformat] AS [ff_fileformat],

       [ff_columndelimiter] AS [ff_columndelimiter],

       [ff_rowdelimiter] AS [ff_rowdelimiter],

       [ff_quotecharacter] AS [ff_quotecharacter],

       [ff_compressionlevel] AS [ff_compressionlevel],

       [ff_compressiontype] AS [ff_compressiontype],

       [ff_enablecdc] AS [ff_enablecdc],

       [ff_escapecharacter] AS [ff_escapecharacter],

       [ff_fileencoding] AS [ff_fileencoding],

       [ff_firstrow] AS [ff_firstrow],

       [ff_firstrowasheader] AS [ff_firstrowasheader],

       [repositorystatusname] AS [repositorystatusname],

       [repositorystatuscode] AS [repositorystatuscode],

       [mta_rectype],

       [mta_createdate],

       [mta_source],

       [mta_bk],

       [mta_bkh],

       [mta_rh],

       [mta_isdeleted] = iif([mta_rectype] = -1, 1, 0)

  FROM cur

 WHERE [mta_currentflag] = 1

   AND [mta_rectype] > -1
