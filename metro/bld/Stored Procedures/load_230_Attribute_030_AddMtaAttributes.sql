
CREATE proc [bld].[load_230_attribute_030_addmtaattributes] AS /*
	Proc is generated by	: metro
	Generated at			: 2025-01-06 14:43:27
	makes use of Smartload!
	exec [bld].[load_230_Attribute_030_AddMtaAttributes]*/  DECLARE @routinename varchar(8000) = 'load_230_Attribute_030_AddMtaAttributes' DECLARE @startdatetime datetime2 = getutcdate() DECLARE @enddatetime datetime2 DECLARE @duration bigint -- Create a helper temp table
 IF object_id('tempdb..#230_Attribute_030_AddMtaAttributes') IS NOT NULL
DROP TABLE # 230_attribute_030_addmtaattributes ; PRINT '-- create temp table:'
SELECT mta_bk = src.[bk] ,

       mta_bkh = convert(char(64),(hashbytes('sha2_512', upper(src.bk))),2) ,

       mta_rh = convert(char(64),(hashbytes('sha2_512', upper(isnull(cast(src.[bk] AS varchar(8000)), '-') + '|' + isnull(cast(src.[code] AS varchar(8000)), '-') + '|' + isnull(cast(src.[name] AS varchar(8000)), '-') + '|' + isnull(cast(src.[bk_dataset] AS varchar(8000)), '-') + '|' + isnull(cast(src.[dataset] AS varchar(8000)), '-') + '|' + isnull(cast(src.[attributename] AS varchar(8000)), '-') + '|' + isnull(cast(src.[description] AS varchar(8000)), '-') + '|' + isnull(cast(src.[expression] AS varchar(8000)), '-') + '|' + isnull(cast(src.[distributionhashkey] AS varchar(8000)), '-') + '|' + isnull(cast(src.[notinrh] AS varchar(8000)), '-') + '|' + isnull(cast(src.[businesskey] AS varchar(8000)), '-') + '|' + isnull(cast(src.[ismta] AS varchar(8000)), '-') + '|' + isnull(cast(src.[srcname] AS varchar(8000)), '-') + '|' + isnull(cast(src.[bk_reftype_datatype] AS varchar(8000)), '-') + '|' + isnull(cast(src.[datatype] AS varchar(8000)), '-') + '|' + isnull(cast(src.[fixedschemadatatype] AS varchar(8000)), '-') + '|' + isnull(cast(src.[orgmappeddatatype] AS varchar(8000)), '-') + '|' + isnull(cast(src.[isnullable] AS varchar(8000)), '-') + '|' + isnull(cast(src.[ordinalposition] AS varchar(8000)), '-') + '|' + isnull(cast(src.[maximumlength] AS varchar(8000)), '-') + '|' + isnull(cast(src.[precision] AS varchar(8000)), '-') + '|' + isnull(cast(src.[scale] AS varchar(8000)), '-') + '|' + isnull(cast(src.[collation] AS varchar(8000)), '-') + '|' + isnull(cast(src.[defaultvalue] AS varchar(8000)), '-') + '|' + isnull(cast(src.[active] AS varchar(8000)), '-') + '|' + isnull(cast(src.[floworder] AS varchar(8000)), '-') + '|' + isnull(cast(src.[bk_reftype_objecttype] AS varchar(8000)), '-') + '|' + isnull(cast(src.[bk_reftype_repositorystatus] AS varchar(8000)), '-') + '|' + isnull(cast(src.[ddl_type1] AS varchar(8000)), '-') + '|' + isnull(cast(src.[ddl_type2] AS varchar(8000)), '-') + '|' + isnull(cast(src.[ddl_type3] AS varchar(8000)), '-') + '|' + isnull(cast(src.[ddl_type4] AS varchar(8000)), '-')))),2) ,

       mta_source = '[bld].[tr_230_Attribute_030_AddMtaAttributes]' ,

       mta_rectype = diff.rectype INTO # 230_attribute_030_addmtaattributes

  FROM [bld].[tr_230_attribute_030_addmtaattributes] src

  LEFT JOIN [bld].[vw_attribute] tgt
    ON src.[bk] = tgt.[bk]

  JOIN [bld].[vw_attributesmartload] diff
    ON diff.code = src.code

 WHERE 1 = 1

   AND cast(diff.rectype AS int) > -99
  CREATE clustered INDEX [ix_tr_230_attribute_030_addmtaattributes]
    ON # 230_attribute_030_addmtaattributes([mta_bkh] ASC, [mta_rh] ASC) --------------------- start loading data
 PRINT '-- new records:'

   SET @startdatetime = getdate()
  INSERT INTO [bld].[attribute] ([bk], [code], [name], [bk_dataset], [dataset], [attributename], [description], [expression], [distributionhashkey], [notinrh], [businesskey], [ismta], [srcname], [bk_reftype_datatype], [datatype], [fixedschemadatatype], [orgmappeddatatype], [isnullable], [ordinalposition], [maximumlength], [precision], [scale], [collation], [defaultvalue], [active], [floworder], [bk_reftype_objecttype], [bk_reftype_repositorystatus], [ddl_type1], [ddl_type2], [ddl_type3], [ddl_type4] , [mta_bk], [mta_bkh], [mta_rh], [mta_source], [mta_rectype])
SELECT src.[bk],

       src.[code],

       src.[name],

       src.[bk_dataset],

       src.[dataset],

       src.[attributename],

       src.[description],

       src.[expression],

       src.[distributionhashkey],

       src.[notinrh],

       src.[businesskey],

       src.[ismta],

       src.[srcname],

       src.[bk_reftype_datatype],

       src.[datatype],

       src.[fixedschemadatatype],

       src.[orgmappeddatatype],

       src.[isnullable],

       src.[ordinalposition],

       src.[maximumlength],

       src.[precision],

       src.[scale],

       src.[collation],

       src.[defaultvalue],

       src.[active],

       src.[floworder],

       src.[bk_reftype_objecttype],

       src.[bk_reftype_repositorystatus],

       src.[ddl_type1],

       src.[ddl_type2],

       src.[ddl_type3],

       src.[ddl_type4] ,

       h.[mta_bk],

       h.[mta_bkh],

       h.[mta_rh],

       h.[mta_source],

       h.[mta_rectype]

  FROM [bld].[tr_230_attribute_030_addmtaattributes] src

  JOIN # 230_attribute_030_addmtaattributes h
    ON h.[mta_bk] = src.[bk]

  LEFT JOIN [bld].[vw_attribute] tgt
    ON h.[mta_bkh] = tgt.[mta_bkh]

 WHERE 1 = 1

   AND cast(h.mta_rectype AS int) = 1

   AND tgt.[mta_bkh] IS NULL

   SET @enddatetime = getutcdate() EXEC [aud].[proc_log_procedure] @logaction = 'INSERT - NEW',

       @lognote = 'New Records',

       @logprocedure = @routinename,

       @logsql = 'Insert Into [bld].[Attribute]',

       @logrowcount = @@ rowcount,

       @log_timestart = @startdatetime,

       @log_timeend = @enddatetime; PRINT '-- changed records:'

   SET @startdatetime = getdate()
  INSERT INTO [bld].[attribute] ([bk], [code], [name], [bk_dataset], [dataset], [attributename], [description], [expression], [distributionhashkey], [notinrh], [businesskey], [ismta], [srcname], [bk_reftype_datatype], [datatype], [fixedschemadatatype], [orgmappeddatatype], [isnullable], [ordinalposition], [maximumlength], [precision], [scale], [collation], [defaultvalue], [active], [floworder], [bk_reftype_objecttype], [bk_reftype_repositorystatus], [ddl_type1], [ddl_type2], [ddl_type3], [ddl_type4] , [mta_bk], [mta_bkh], [mta_rh], [mta_source], [mta_rectype])
SELECT src.[bk],

       src.[code],

       src.[name],

       src.[bk_dataset],

       src.[dataset],

       src.[attributename],

       src.[description],

       src.[expression],

       src.[distributionhashkey],

       src.[notinrh],

       src.[businesskey],

       src.[ismta],

       src.[srcname],

       src.[bk_reftype_datatype],

       src.[datatype],

       src.[fixedschemadatatype],

       src.[orgmappeddatatype],

       src.[isnullable],

       src.[ordinalposition],

       src.[maximumlength],

       src.[precision],

       src.[scale],

       src.[collation],

       src.[defaultvalue],

       src.[active],

       src.[floworder],

       src.[bk_reftype_objecttype],

       src.[bk_reftype_repositorystatus],

       src.[ddl_type1],

       src.[ddl_type2],

       src.[ddl_type3],

       src.[ddl_type4] ,

       h.[mta_bk],

       h.[mta_bkh],

       h.[mta_rh],

       h.[mta_source],

       h.[mta_rectype]

  FROM [bld].[tr_230_attribute_030_addmtaattributes] src

  JOIN # 230_attribute_030_addmtaattributes h
    ON h.[mta_bk] = src.[bk]

 WHERE 1 = 1

   AND cast(h.mta_rectype AS int) = 0

   SET @enddatetime = getutcdate() EXEC [aud].[proc_log_procedure] @logaction = 'INSERT - CHG',

       @lognote = 'Changed Records',

       @logprocedure = @routinename,

       @logsql = 'Insert Into [bld].[Attribute]',

       @logrowcount = @@ rowcount,

       @log_timestart = @startdatetime,

       @log_timeend = @enddatetime; PRINT '-- deleted records:'

   SET @startdatetime = getdate()
  INSERT INTO [bld].[attribute] ([bk], [code], [name], [bk_dataset], [dataset], [attributename], [description], [expression], [distributionhashkey], [notinrh], [businesskey], [ismta], [srcname], [bk_reftype_datatype], [datatype], [fixedschemadatatype], [orgmappeddatatype], [isnullable], [ordinalposition], [maximumlength], [precision], [scale], [collation], [defaultvalue], [active], [floworder], [bk_reftype_objecttype], [bk_reftype_repositorystatus], [ddl_type1], [ddl_type2], [ddl_type3], [ddl_type4] , [mta_bk], [mta_bkh], [mta_rh], [mta_source], [mta_rectype])
SELECT src.[bk],

       src.[code],

       src.[name],

       src.[bk_dataset],

       src.[dataset],

       src.[attributename],

       src.[description],

       src.[expression],

       src.[distributionhashkey],

       src.[notinrh],

       src.[businesskey],

       src.[ismta],

       src.[srcname],

       src.[bk_reftype_datatype],

       src.[datatype],

       src.[fixedschemadatatype],

       src.[orgmappeddatatype],

       src.[isnullable],

       src.[ordinalposition],

       src.[maximumlength],

       src.[precision],

       src.[scale],

       src.[collation],

       src.[defaultvalue],

       src.[active],

       src.[floworder],

       src.[bk_reftype_objecttype],

       src.[bk_reftype_repositorystatus],

       src.[ddl_type1],

       src.[ddl_type2],

       src.[ddl_type3],

       src.[ddl_type4] ,

       src.[mta_bk],

       src.[mta_bkh],

       src.[mta_rh],

       src.[mta_source],

       [mta_rectype] = -1

  FROM [bld].[vw_attribute] src

  LEFT JOIN # 230_attribute_030_addmtaattributes h
    ON h.[mta_bkh] = src.[mta_bkh]

   AND h.[mta_source] = src.[mta_source]

 WHERE 1 = 1

   AND h.[mta_bkh] IS NULL

   AND src.mta_source = '[bld].[tr_230_Attribute_030_AddMtaAttributes]'

   AND h.mta_rectype = -1

   SET @enddatetime = getutcdate() EXEC [aud].[proc_log_procedure] @logaction = 'INSERT - DEL',

       @lognote = 'Changed Deleted',

       @logprocedure = @routinename,

       @logsql = 'Insert Into [bld].[Attribute]',

       @logrowcount = @@ rowcount,

       @log_timestart = @startdatetime,

       @log_timeend = @enddatetime ; -- Clean up ...
 IF object_id('tempdb..#230_Attribute_030_AddMtaAttributes') IS NOT NULL
  DROP TABLE # 230_attribute_030_addmtaattributes;

   SET @enddatetime = getutcdate()

   SET @duration = datediff(ss, @startdatetime, @enddatetime) PRINT 'Load "load_230_Attribute_030_AddMtaAttributes" took ' + cast(@duration AS varchar(10)) + ' second(s)'
